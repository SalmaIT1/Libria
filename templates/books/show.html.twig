{% extends 'base.html.twig' %}

{% block title %}{{ livre.titre }} - Libria{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="library-card">
                {% if livre.image %}
                    {% set imagePath = 'uploads/books/' ~ livre.image %}
                    <img src="{{ asset(imagePath) }}" 
                         alt="{{ livre.titre }}" 
                         class="book-cover"
                         style="object-fit: cover;"
                         onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="book-cover" style="display: none;">
                        <i class="bi bi-book"></i>
                    </div>
                {% else %}
                    <div class="book-cover">
                        <i class="bi bi-book"></i>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-8">
            <div class="library-card p-4">
                <h1 class="book-title mb-3">{{ livre.titre }}</h1>
                
                <!-- Rating Display -->
                {% if averageRating is defined and averageRating > 0 %}
                <div class="mb-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rating-display">
                            {% set fullStars = (averageRating|round) %}
                            {% set hasHalfStar = (averageRating - fullStars) >= 0.5 %}
                            <div class="stars mb-2">
                                {% for i in 1..5 %}
                                    {% if i <= fullStars %}
                                        <i class="bi bi-star-fill text-warning" style="font-size: 1.5rem;"></i>
                                    {% elseif i == fullStars + 1 and hasHalfStar %}
                                        <i class="bi bi-star-half text-warning" style="font-size: 1.5rem;"></i>
                                    {% else %}
                                        <i class="bi bi-star text-muted" style="font-size: 1.5rem;"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="rating-info">
                                <strong style="color: var(--text-secondary); font-size: 1.2rem;">{{ averageRating|number_format(1) }}</strong>
                                <span class="text-muted">/ 5.0</span>
                                <span class="text-muted ms-2">({{ commentCount }} {{ commentCount == 1 ? 'review' : 'reviews' }})</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="mb-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rating-display">
                            <div class="stars mb-2">
                                {% for i in 1..5 %}
                                    <i class="bi bi-star text-muted" style="font-size: 1.5rem;"></i>
                                {% endfor %}
                            </div>
                            <div class="rating-info">
                                <span class="text-muted">No reviews yet</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <h5 class="book-title">Authors</h5>
                    {% if livre.auteurs|length > 0 %}
                    <p class="mb-2 book-meta">
                        <i class="bi bi-person-fill" style="color: var(--caramel);"></i>
                        {% for auteur in livre.auteurs %}
                            <a href="{{ path('author_show', {id: auteur.id}) }}" class="text-decoration-none" style="font-weight: 500; color: var(--caramel);">
                                {{ auteur.prenom }} {{ auteur.nom }}
                            </a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                {% endif %}
                {% if livre.editeur %}
                    <p class="mb-2 book-meta">
                        <i class="bi bi-building-fill" style="color: var(--mocca);"></i>
                        <a href="{{ path('publisher_show', {id: livre.editeur.id}) }}" class="text-decoration-none" style="font-weight: 500; color: var(--mocca);">{{ livre.editeur.nomEditeur }}</a>
                    </p>
                {% endif %}
                </div>

                <div class="mb-3">
                    <h5 class="book-title">Categories</h5>
                    <p class="book-meta">
                        {% if livre.categories|length > 0 %}
                            {% for categorie in livre.categories %}
                                <span class="badge bg-warning text-dark me-2">
                                    <i class="bi bi-tag"></i> {{ categorie.designation }}
                                </span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No categories assigned</span>
                        {% endif %}
                    </p>
                </div>

                {% if livre.description %}
                    <div class="mb-4">
                        <h5 class="book-title">Description</h5>
                        <p class="book-meta" style="text-align: justify; line-height: 1.8;">{{ livre.description }}</p>
                    </div>
                {% endif %}

                <hr>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="book-meta"><strong>ISBN:</strong> {{ livre.isbn }}</p>
                        <p class="book-meta"><strong>Pages:</strong> {{ livre.nbPages }}</p>
                        <p class="book-meta"><strong>Price:</strong> {{ livre.prix }} TND</p>
                        <p class="book-meta"><strong>Available Copies:</strong> 
                            {% if livre.nbExemplaires > 0 %}
                                <span class="text-success">{{ livre.nbExemplaires }} in stock</span>
                            {% else %}
                                <span class="text-danger">Out of stock</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        {% if livre.dateEdition %}
                            <p class="book-meta"><strong>Publication Date:</strong> {{ livre.dateEdition|date('F Y') }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-4 d-flex gap-2 flex-wrap action-buttons">
                    <a href="{{ path('books') }}" class="btn btn-library">
                        <i class="bi bi-arrow-left"></i> Back to Books
                    </a>
                    {% if app.user and not is_granted('ROLE_ADMIN') %}
                        {% if livre.nbExemplaires > 0 %}
                            <button class="btn btn-success add-to-cart-detail" 
                                    data-livre-id="{{ livre.id }}"
                                    data-livre-title="{{ livre.titre }}"
                                    data-livre-price="{{ livre.prix }}">
                                <i class="bi bi-cart-plus"></i> Add to Cart
                            </button>
                        {% else %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-x-circle"></i> Out of Stock
                            </button>
                        {% endif %}
                        <button class="btn btn-outline-danger toggle-favorite" data-book-id="{{ livre.id }}" id="favorite-btn">
                            <i class="bi bi-heart"></i> <span id="favorite-text">Add to Favorites</span>
                        </button>
                        {% if livre.nbExemplaires > 0 %}
                            <button type="button" 
                                    class="btn btn-outline-primary borrow-book-btn" 
                                    data-action="{{ path('emprunt_create', {id: livre.id}) }}"
                                    data-message="Are you sure you want to borrow this book?">
                                <i class="bi bi-book"></i> Borrow Book
                            </button>
                        {% else %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-x-circle"></i> Not Available
                            </button>
                        {% endif %}
                    {% endif %}
                    {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('admin') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-pencil"></i> Edit in Admin
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h2 class="section-title mb-4">
                    <i class="bi bi-chat-dots"></i> Reviews & Comments
                </h2>
            </div>
        </div>

        <!-- Add Comment Form -->
        {% if app.user and not is_granted('ROLE_ADMIN') %}
            <div class="row mb-5">
                <div class="col-12">
                    <div class="library-card p-4">
                        <h4 class="book-title mb-3">
                            <i class="bi bi-pencil-square"></i> Write a Review
                        </h4>
                        {{ form_start(form, {'attr': {'class': 'needs-validation'}}) }}
                            <div class="mb-3">
                                {{ form_label(form.rating, null, {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                                {{ form_widget(form.rating, {'attr': {'class': 'form-select'}}) }}
                                {{ form_errors(form.rating) }}
                            </div>
                            <div class="mb-3">
                                {{ form_label(form.contenu, null, {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                                {{ form_widget(form.contenu, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.contenu) }}
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-library">
                                    <i class="bi bi-send"></i> Submit Review
                                </button>
                            </div>
                        {{ form_end(form) }}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="row mb-5">
                <div class="col-12">
                    <div class="library-card p-4 text-center">
                        {% if is_granted('ROLE_ADMIN') %}
                            <p class="book-meta mb-3">
                                <i class="bi bi-shield-exclamation"></i> Administrators cannot leave reviews on books.
                            </p>
                        {% else %}
                            <p class="book-meta mb-3">
                                <i class="bi bi-lock"></i> You must be logged in to leave a review.
                            </p>
                            <a href="{{ path('login') }}" class="btn btn-library">
                                <i class="bi bi-box-arrow-in-right"></i> Login to Review
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Comments List -->
        <div class="row">
            <div class="col-12">
                {% if commentaires is empty %}
                    <div class="library-card p-5 text-center">
                        <i class="bi bi-chat" style="font-size: 4rem; color: var(--almond);"></i>
                        <h4 class="book-title mt-3">No Reviews Yet</h4>
                        <p class="book-meta">Be the first to review this book!</p>
                    </div>
                {% else %}
                    {% for commentaire in commentaires %}
                        <div class="library-card p-4 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="book-title mb-1">
                                        <i class="bi bi-person-circle"></i> 
                                        {{ commentaire.user.firstName ?? '' }} {{ commentaire.user.lastName ?? '' }}
                                        {% if not commentaire.user.firstName and not commentaire.user.lastName %}
                                            {{ commentaire.user.email }}
                                        {% endif %}
                                    </h5>
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> {{ commentaire.dateCreation|date('F d, Y') }}
                                    </small>
                                </div>
                                <div class="rating-stars">
                                    {% for i in 1..5 %}
                                        {% if i <= commentaire.rating %}
                                            <i class="bi bi-star-fill text-warning"></i>
                                        {% else %}
                                            <i class="bi bi-star text-muted"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <p class="book-meta mb-0" style="white-space: pre-wrap;">{{ commentaire.contenu }}</p>
                            {% if app.user and (commentaire.user == app.user) %}
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary edit-comment-btn" 
                                            data-comment-id="{{ commentaire.id }}"
                                            data-comment-content="{{ commentaire.contenu|e('html_attr') }}"
                                            data-comment-rating="{{ commentaire.rating }}">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger delete-comment-btn" 
                                            data-comment-id="{{ commentaire.id }}"
                                            data-action="{{ path('comment_delete', {id: commentaire.id}) }}">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            {% elseif app.user and is_granted('ROLE_ADMIN') %}
                                <div class="mt-3">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger delete-comment-btn" 
                                            data-comment-id="{{ commentaire.id }}"
                                            data-action="{{ path('comment_delete', {id: commentaire.id}) }}">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Edit Comment Modal -->
    <div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCommentModalLabel">Edit Your Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCommentForm" method="post">
                        <input type="hidden" id="editCommentId" name="comment_id">
                        
                        <div class="mb-3">
                            <label for="editRating" class="form-label">Rating</label>
                            <div class="rating-input">
                                {% for i in 1..5 %}
                                    <input type="radio" id="editStar{{ i }}" name="rating" value="{{ i }}" class="d-none">
                                    <label for="editStar{{ i }}" class="star-label">
                                        <i class="bi bi-star"></i>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editContenu" class="form-label">Your Review</label>
                            <textarea class="form-control" id="editContenu" name="contenu" rows="4" 
                                    placeholder="Share your thoughts about this book..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="editCommentForm" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Fix modal overlay issues */
        #editCommentModal {
            z-index: 1055;
        }
        
        #editCommentModal .modal-dialog {
            z-index: 1056;
        }
        
        #editCommentModal .modal-content {
            z-index: 1057;
            position: relative;
        }
        
        #confirmModal {
            z-index: 1055;
        }
        
        #confirmModal .modal-dialog {
            z-index: 1056;
        }
        
        #confirmModal .modal-content {
            z-index: 1057;
            position: relative;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }
        
        .rating-display .stars {
            display: flex;
            gap: 0.25rem;
        }
        .rating-info {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        .rating-stars {
            display: flex;
            gap: 0.2rem;
            font-size: 1.2rem;
        }
        .action-buttons {
            align-items: stretch;
        }
        .action-buttons .btn,
        .action-buttons-form .btn {
            height: 38px;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            box-sizing: border-box;
            gap: 0.5rem;
        }
        .action-buttons .btn i,
        .action-buttons-form .btn i {
            margin-right: 0;
        }
        .action-buttons-form {
            display: inline-flex;
            margin: 0;
            padding: 0;
            height: 38px;
            align-items: stretch;
        }
        .action-buttons-form button {
            width: 100%;
            height: 100%;
        }
        
        .rating-input {
            display: flex;
            gap: 0.25rem;
        }
        
        .rating-input .star-label {
            font-size: 1.5rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
            z-index: 1060;
        }
        
        .rating-input input[type="radio"] {
            position: relative;
            z-index: 1061;
        }
        
        .rating-input .star-label:hover,
        .rating-input input:checked ~ .star-label {
            color: #ffc107;
        }
        
        .rating-input input:checked ~ .star-label {
            color: #ffc107;
        }
    </style>

    <script>
        {% if app.user %}
        // Check if book is in favorites
        fetch('/favoris/check/{{ livre.id }}')
            .then(response => response.json())
            .then(data => {
                const btn = document.getElementById('favorite-btn');
                const text = document.getElementById('favorite-text');
                if (data.isFavorite) {
                    btn.classList.add('active');
                    btn.querySelector('i').classList.remove('bi-heart');
                    btn.querySelector('i').classList.add('bi-heart-fill');
                    text.textContent = 'Remove from Favorites';
                } else {
                    btn.classList.remove('active');
                    btn.querySelector('i').classList.remove('bi-heart-fill');
                    btn.querySelector('i').classList.add('bi-heart');
                    text.textContent = 'Add to Favorites';
                }
            });

        // Toggle favorite
        document.querySelector('.toggle-favorite')?.addEventListener('click', async function() {
            const bookId = this.dataset.bookId;
            const response = await fetch(`/favoris/toggle/${bookId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await response.json();
            const btn = this;
            const icon = btn.querySelector('i');
            const text = document.getElementById('favorite-text');
            
            if (data.added) {
                btn.classList.add('active');
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill');
                text.textContent = 'Remove from Favorites';
            } else {
                btn.classList.remove('active');
                icon.classList.remove('bi-heart-fill');
                icon.classList.add('bi-heart');
                text.textContent = 'Add to Favorites';
            }
        });

        // Add to Cart functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up cart functionality...'); // Debug
            
            const addToCartButton = document.querySelector('.add-to-cart-detail');
            console.log('Add to cart button found:', addToCartButton); // Debug
        
        addToCartButton?.addEventListener('click', function() {
            console.log('Add to cart clicked'); // Debug: vérifier si la fonction s'exécute
            
            const livreId = this.dataset.livreId;
            const livreTitle = this.dataset.livreTitle;
            const livrePrice = this.dataset.livrePrice;
            
            console.log('Book data:', { livreId, livreTitle, livrePrice }); // Debug: voir les données
            console.log('Button dataset:', this.dataset); // Debug: voir tous les attributs data
            
            // Vérifier si les données sont présentes
            if (!livreId) {
                console.error('Missing livreId in button dataset');
                showToast('Error: Book ID not found', 'error');
                return;
            }
            
            // Show loading state
            const originalContent = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
            this.disabled = true;
            
            fetch(`/cart/add/${livreId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `quantity=1`
            })
            .then(response => response.json())
            .then(data => {
                console.log('Cart response:', data); // Debug: voir la réponse complète
                
                if (data.success) {
                    console.log('Success condition true - updating cart...');
                    // Update cart count in navbar
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    } else {
                        // Fallback: update cart count manually
                        const cartBadge = document.getElementById('cart-badge');
                        if (data.cartCount > 0) {
                            cartBadge.textContent = data.cartCount;
                            cartBadge.style.display = 'inline-block';
                        } else {
                            cartBadge.style.display = 'none';
                        }
                    }
                    
                    // Force update cart dropdown content
                    console.log('Updating cart dropdown...');
                    try {
                        // Method 1: Try refreshCartDropdown
                        if (typeof refreshCartDropdown === 'function') {
                            console.log('Using refreshCartDropdown');
                            refreshCartDropdown();
                        }
                        // Method 2: Try loadCartDropdown
                        else if (typeof loadCartDropdown === 'function') {
                            console.log('Using loadCartDropdown');
                            loadCartDropdown();
                        }
                        // Method 3: Simple manual dropdown update
                        else {
                            console.log('Simple manual dropdown update');
                            
                            // Update cart badge first
                            const cartBadge = document.getElementById('cart-badge');
                            const countBadge = document.getElementById('cart-count-badge');
                            if (data.cartCount > 0) {
                                if (cartBadge) {
                                    cartBadge.textContent = data.cartCount;
                                    cartBadge.style.display = 'inline-block';
                                }
                                if (countBadge) {
                                    countBadge.textContent = data.cartCount;
                                }
                            } else {
                                if (cartBadge) cartBadge.style.display = 'none';
                                if (countBadge) countBadge.textContent = '0';
                            }
                            
                            // Simple dropdown update
                            const cartItems = document.getElementById('cart-items');
                            const cartEmpty = document.getElementById('cart-empty');
                            const cartTotal = document.getElementById('cart-total');
                            const cartLoading = document.getElementById('cart-loading');
                            
                            if (cartLoading) cartLoading.style.display = 'block';
                            if (cartItems) cartItems.innerHTML = '';
                            if (cartEmpty) cartEmpty.style.display = 'none';
                            
                            // Fetch cart page content
                            fetch('/cart')
                                .then(response => response.text())
                                .then(html => {
                                    if (cartLoading) cartLoading.style.display = 'none';
                                    
                                    // Simple approach: look for any table rows or cart items
                                    const parser = new DOMParser();
                                    const doc = parser.parseFromString(html, 'text/html');
                                    
                                    // Try different selectors that might exist
                                    const items = doc.querySelectorAll('tr') || 
                                                  doc.querySelectorAll('.cart-item') || 
                                                  doc.querySelectorAll('[class*="item"]') ||
                                                  doc.querySelectorAll('[class*="product"]');
                                    
                                    console.log('Found items:', items.length);
                                    
                                    if (items.length > 0) {
                                        let itemsHtml = '';
                                        let total = 0;
                                        let itemCount = 0;
                                        
                                        items.forEach((item, index) => {
                                            if (index < 3 && itemCount < 3) {
                                                // Try to extract title, price, quantity from various possible elements
                                                const titleEl = item.querySelector('td:first-child') || 
                                                               item.querySelector('.title') || 
                                                               item.querySelector('[class*="title"]') ||
                                                               item.querySelector('h3, h4, h5');
                                                const priceEl = item.querySelector('[class*="price"]') || 
                                                               item.querySelector('td:nth-child(2)') ||
                                                               item.querySelector('.amount');
                                                const qtyEl = item.querySelector('[class*="quantity"]') || 
                                                              item.querySelector('td:nth-child(3)') ||
                                                              item.querySelector('input[type="number"]');
                                                
                                                const title = titleEl ? titleEl.textContent.trim() : 'Product ' + (index + 1);
                                                const priceText = priceEl ? priceEl.textContent.trim() : '0.00';
                                                const qty = qtyEl ? qtyEl.value || qtyEl.textContent.trim() : '1';
                                                
                                                // Extract numeric price
                                                const price = parseFloat(priceText.replace(/[^0-9.]/g, '')) || 0;
                                                const quantity = parseInt(qty) || 1;
                                                const itemTotal = price * quantity;
                                                total += itemTotal;
                                                itemCount++;
                                                
                                                itemsHtml += `
                                                    <div class="cart-item px-3 py-2 border-bottom">
                                                        <div class="d-flex align-items-center">
                                                            <div class="ms-3 flex-grow-1">
                                                                <div class="fw-semibold text-truncate" style="font-size: 0.85rem; max-width: 200px;">${title}</div>
                                                                <div class="text-muted small">${qty} × ${price.toFixed(2)} TND</div>
                                                            </div>
                                                            <div class="text-end">
                                                                <div class="fw-bold" style="font-size: 0.85rem;">${itemTotal.toFixed(2)} TND</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                        });
                                        
                                        if (itemCount > 0) {
                                            if (cartItems) cartItems.innerHTML = itemsHtml;
                                            if (cartTotal) cartTotal.textContent = total.toFixed(2) + ' TND';
                                        } else {
                                            if (cartEmpty) cartEmpty.style.display = 'block';
                                            if (cartTotal) cartTotal.textContent = '0.00 TND';
                                        }
                                    } else {
                                        // No items found - show empty cart
                                        if (cartEmpty) cartEmpty.style.display = 'block';
                                        if (cartTotal) cartTotal.textContent = '0.00 TND';
                                    }
                                })
                                .catch(error => {
                                    console.error('Cart update error:', error);
                                    if (cartLoading) cartLoading.style.display = 'none';
                                    if (cartEmpty) cartEmpty.style.display = 'block';
                                    if (cartTotal) cartTotal.textContent = '0.00 TND';
                                });
                        }
                    } catch (error) {
                        console.error('Cart dropdown update error:', error);
                    }
                    
                    // Show success message
                    this.innerHTML = '<i class="bi bi-check-circle"></i> Added!';
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-success');
                    
                    // Show toast notification
                    showToast(`"${livreTitle}" added to cart successfully!`, 'success');
                    
                    // Reset button after delay
                    setTimeout(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                        this.classList.remove('btn-outline-success');
                        this.classList.add('btn-success');
                    }, 2000);
                } else {
                    console.log('Success condition false - data:', data);
                    // Show error
                    this.innerHTML = originalContent;
                    this.disabled = false;
                    showToast(data.error || 'Error adding to cart', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = originalContent;
                this.disabled = false;
                showToast('Error adding to cart', 'error');
            });
        });
        });
        {% endif %}

        // Edit Comment functionality (always available)
        const editModal = document.getElementById('editCommentModal');
        const editForm = document.getElementById('editCommentForm');
        
        // Update star display function
        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#editCommentForm .rating-input .star-label i');
            stars.forEach((icon, index) => {
                const starValue = index + 1;
                if (starValue <= rating) {
                    icon.classList.remove('bi-star');
                    icon.classList.add('bi-star-fill');
                } else {
                    icon.classList.remove('bi-star-fill');
                    icon.classList.add('bi-star');
                }
            });
        }
        
        // Handle rating changes in modal
        document.addEventListener('change', function(e) {
            if (e.target.matches('input[name="rating"]')) {
                updateStarDisplay(e.target.value);
            }
        });
        
        // Handle form submission
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const commentId = document.getElementById('editCommentId').value;
            const contenu = document.getElementById('editContenu').value;
            const rating = document.querySelector('input[name="rating"]:checked')?.value;
            
            if (!contenu || !rating) {
                showToast('Please provide both rating and comment', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('contenu', contenu);
            formData.append('rating', rating);
            
            fetch(`/comment/edit/${commentId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                const isJson = response.headers.get('content-type')?.includes('application/json');
                return isJson ? response.json() : response.text().then(text => ({ success: response.ok, error: text }));
            })
            .then(data => {
                if (data.success) {
                    showToast('Comment updated successfully!', 'success');
                    bootstrap.Modal.getInstance(editModal).hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || 'Error updating comment', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error updating comment', 'error');
            });
        });

        // Custom Confirmation Modal
        let pendingAction = null;
        
        console.log('JavaScript loaded - setting up event listeners');
        
        document.addEventListener('click', function(e) {
            // Edit comment buttons
            if (e.target.closest('.edit-comment-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.edit-comment-btn');
                const commentId = btn.dataset.commentId;
                const content = btn.dataset.commentContent ? decodeURIComponent(btn.dataset.commentContent) : '';
                const rating = btn.dataset.commentRating;
                
                // Populate modal
                document.getElementById('editCommentId').value = commentId;
                document.getElementById('editContenu').value = content;
                
                // Set rating
                const ratingInput = document.querySelector(`input[name="rating"][value="${rating}"]`);
                if (ratingInput) ratingInput.checked = true;
                
                // Update star display
                updateStarDisplay(rating);
                
                // Show modal
                try {
                    // Hide any existing backdrops
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                        backdrop.remove();
                    });
                    
                    // Remove backdrop classes from body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    const modalInstance = new bootstrap.Modal(editModal, {
                        backdrop: false,
                        keyboard: true
                    });
                    modalInstance.show();
                } catch (error) {
                    console.error('Error showing modal:', error);
                }
            }
            
            // Delete comment buttons
            if (e.target.closest('.delete-comment-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.delete-comment-btn');
                pendingAction = () => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = btn.dataset.action;
                    document.body.appendChild(form);
                    form.submit();
                };
                showConfirmModal('Are you sure you want to delete this comment?');
            }
            
            // Borrow book buttons
            if (e.target.closest('.borrow-book-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.borrow-book-btn');
                pendingAction = () => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = btn.dataset.action;
                    document.body.appendChild(form);
                    form.submit();
                };
                showConfirmModal(btn.dataset.message);
            }
        });
        
        function showConfirmModal(message) {
            // Hide any existing backdrops
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            
            // Remove backdrop classes from body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            document.getElementById('confirmMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'), {
                backdrop: false,
                keyboard: true
            });
            modal.show();
        }
        
        document.getElementById('confirmButton').addEventListener('click', function() {
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${type === 'error' ? 'x-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</div>
{% endblock %}
